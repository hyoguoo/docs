# 데이터 처리

MySQL 서버를 포함한 모든 RDBMS는 데이터를 정렬하거나 그루핑하는 등 기본 데이터 가공 기능을 가지고 있으며, 엔지별로 데이터 처리 방식은 모두 다르다.

## 리드 어헤드(Read ahead)

> 어떤 영역의 데이터가 앞으로 필요해지리라는 것을 예측해 요청이 오기 전에 미리 디스크에서 읽어 InnoDB 버퍼 풀에 가져다 두는 것

보통 테이블의 전체 크기는 인덱스보다 훨씬 크기 때문에 풀 테이블 스캔은 상당히 많은 디스크 읽기가 필요한데, 이를 향상시키기 위해 InnoDB 리드 어헤드(Read Ahead) 기능을 사용한다.  
InnoDB 스토리지 엔진은 특정 테이블의 연속된 데이터 페이지가 읽히면 백그라운드 스레드에 의해 리드 어헤드(Read ahead) 작업이 자동 시작된다.  
테이블 풀 스캔 시 작업은 아래와 같이 진행된다.

1. 풀 스캔이 실행되면 포그라운드 스레드(Foreground Thread)에 의해 처음 몇 개의 데이터 페이지가 읽힘
2. 특정 시점부터 백그라운드 스레드가 읽기 작업을 시작
3. 백그라운드 스레드는 한 번에 읽는 페이지 수를 늘려가며 읽기 작업을 진행
4. 읽은 페이지를 버퍼 풀에 저장
5. 포그라운드 스레드는 백그라운드 스레드가 읽은 페이지(버퍼 풀)에서 가져다가 사용

풀 테이블 스캔과 풀 인덱스 스캔은 아래와 같은 경우 실행되며 리드 어헤드(Read ahead) 기능을 사용하게 된다.

- 풀 테이블 스캔(Full Table Scan): 아래의 조건을 만족하는 경우 풀 테이블 스캔을 수행한다.
    - 테이블의 레코드 건수가 너무 작아 인덱스를 사용하는 것보다 테이블을 읽는 것이 빠른 경우(보통 테이블이 페지이 1개로 구성된 경우)
    - WHERE 절 혹은 ON 절에 이용할 수 있는 적절한 조건이 없는 경우
    - 인덱스 레인지 스캔을 사용할 수 있지만 옵티마이저 판단한 조건 일치 레코드 건수가 너무 많은 경우
- 풀 인덱스 스캔(Full Index Scan): 모든 레코드를 읽어야 하는 것이 아닌 레코드 건수만 조회하는 경우 풀 인덱스 스캔으로 처리
    - `SELECT COUNT(*) FROM table_name` 같은 경우 가능
    - 용량이 적어 디스크 읽기 횟수가 줄어 훨씬 빠른 속도로 처리

## 병렬 처리

> 하나의 쿼리를 여러 스레드가 작업을 나누어 처리하는 것

MySQL 8.0에서 병렬 처리 기능이 추가되었으나, WHERE 조건 없이 단순이 테이블 전체 건수를 가져오는 경우에만 병렬 처리가 가능하다.  
스레드 수를 늘려 서버에 장착된 코어 개수를 넘어가게 되는 경우 오히려 성능이 떨어질 수 있다.

```mysql
SET SESSION innodb_parallel_read_threads = 4;

SELECT COUNT(*)
FROM TABLE_NAME;
```

###### 참고자료

- [Real MySQL 8.0 1](https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=284710853)
