# Connection

## TCP 커넥션

HTTP를 사용하는 클라이언트와 서버는 TCP 커넥션을 통해 통신한다. 여기서 커넥션이 맺어지면 클라이언트와 서버는 HTTP 메시지들을 손상되거나 손실되지 않고, 순서대로 교환할 수 있게 된다.

### 신뢰할 수 있는 데이터 전송 통로 제공

HTTP 커넥션은 몇몇 사용 규칙을 제외하고는 TCP 커넥션에 불과하며, TCP 커넥션이 인터넷을 안정적으로 연결해주는 역할을 하게된다.  
TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공하고, 바이트들을 반대쪽으로 순서에 맞게 정확하게 전송해준다.

### TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송

1. HTTP가 메시지를 전송할 경우, TCP 커넥션을 통해 메시지 데이터의 내용을 순서대로 보냄
2. `TCP가 세그먼트` 단위로 `데이터 스트림`을 잘게 나눔
3. 세그먼트를 아래의 데이터를 지닌 `IP 패킷`으로 나누어 인터넷을 통해 전송
    - IP 패킷 헤더
        - 버전 / 헤더 길이 / 서비스 유형 / 총 데이터그램 길이(바이트)
        - 패킷 ID / 플래그 / 플래그 오프셋
        - 유지 시간(TTL) / 상위 계층 프로토콜 / 헤더 체크섬
        - 발신지 IP 주소
        - 목적지 IP 주소
    - TCP 세그먼트 헤더
        - 발신지 포트 / 목적지 포트
        - TCP 순서 번호
        - 편승(piggback) 확인 응답
        - 헤더 길이 / 예약어 / URG / ACK / PSH / RST / SYN / FIN / 윈도우 크기
        - TCP 체크섬
        - 긴급 포인터
    - TCP 데이터 조각
        - HTTP 메시지

### TCP 커넥션 유지

컴퓨터는 항상 여러 개의 TCP 커넥션을 유지하고 있는데, 이를 아래 네 가지 값으로 구분하고 유지한다.

- 발신자 IP 주소
- 발신자 포트
- 수신자 IP 주소
- 수신자 포트

서로 다른 두 개의 커넥션은 네 가지 구성 요소의 값이 모두 같을 수 없다.

### TCP 소켓 프로그래밍

운영체제는 TCP 커넥션의 생성과 관련된 아래에 있는 여러 기능을 제공한다.

- 연결 되지 않은 익명의 소켓 생성
- 소켓에 로컬 포트 번호와 인터페이스 할당
- 로컬의 소켓과 원격의 호스트 및 포트 사이에 TCP 커넥션 생성
- 커넥션을 받아들이기 위해 로컬 소켓에 허용함을 표시
- ...
- TCP 커넥션을 완전히 끊음
- TCP 커넥션의 입출력만 닫음
- ...

위의 API는 유닉스 운영체제용으로 먼저 개발되었으나, 지금은 소켓 API의 다양한 구현체들 덕분에 대부분 운영체제나 프로그램 언어에서 사용할 수 있다.

- 소켓 인터페이스를 사용한 HTTP 네트워크

|     클라이언트     |       서버       |
|:-------------:|:--------------:|
|               |   새로운 소켓 생성    |
|               |  80포트로 소켓을 묶음  |
|               |   소켓 커넥션 허가    |
|               |    커넥션을 기다림    |
| IP 주소와 포트를 얻음 |                |
|   새로운 소켓 생성   |                |
| 서버의 IP 포트로 연결 |                |
|               | 애플리케이션 커넥션 통지  |
|               |   요청을 읽기 시작    |
|     연결 성공     |                |
|  HTTP 요청을 보냄  |                |
|  HTTP 응답 대기   |                |
|               | HTTP 요청 메시지 처리 |
|               | HTTP 응답 메시지 전송 |
|  HTTP 응답 처리   |                |
|    커넥션 닫음     |     커넥션 닫음     |

###### 출처

- [HTTP 완벽 가이드](https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=294437345)