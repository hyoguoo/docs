# TCP - 전송 제어 프로토콜(Transmission Control Protocol)

> 트랜스포츠(Transport) 계층에 해당되며, 신뢰성 있는 바이트 스트림 서비스를 제공

HTTP를 사용하는 클라이언트와 서버는 TCP 커넥션을 통해 통신한다. 여기서 커넥션이 맺어지면 클라이언트와 서버는 HTTP 메시지들을 손상되거나 손실되지 않고, 순서대로 교환할 수 있게 된다.

## 신뢰할 수 있는 데이터 전송 통로 제공

HTTP 커넥션은 몇몇 사용 규칙을 제외하고는 TCP 커넥션에 불과하며, TCP 커넥션이 인터넷을 안정적으로 연결해주는 역할을 하게된다.  
TCP는 HTTP에게 신뢰할 만한 통신 방식을 제공하고, 바이트들을 반대쪽으로 순서에 맞게 정확하게 전송해준다.

## TCP 스트림은 세그먼트로 나뉘어 IP 패킷을 통해 전송

1. HTTP가 메시지를 전송할 경우, TCP 커넥션을 통해 메시지 데이터의 내용을 순서대로 보냄
2. `TCP가 세그먼트` 단위로 `데이터 스트림`을 잘게 나눔
3. 세그먼트를 아래의 데이터를 지닌 `IP 패킷`으로 나누어 인터넷을 통해 전송

## TCP 커넥션 유지

컴퓨터는 항상 여러 개의 TCP 커넥션을 유지하고 있는데, 이를 아래 네 가지 값으로 구분하고 유지한다.

- 발신자 IP 주소
- 발신자 포트
- 수신자 IP 주소
- 수신자 포트

서로 다른 두 개의 커넥션은 네 가지 구성 요소의 값이 모두 같을 수 없다.

## TCP 소켓 프로그래밍

운영체제는 TCP 커넥션의 생성과 관련된 아래에 있는 여러 기능을 제공한다.

- 연결 되지 않은 익명의 소켓 생성
- 소켓에 로컬 포트 번호와 인터페이스 할당
- 로컬의 소켓과 원격의 호스트 및 포트 사이에 TCP 커넥션 생성
- 커넥션을 받아들이기 위해 로컬 소켓에 허용함을 표시
- ...
- TCP 커넥션을 완전히 끊음
- TCP 커넥션의 입출력만 닫음
- ...

위의 API는 유닉스 운영체제용으로 먼저 개발되었으나, 지금은 소켓 API의 다양한 구현체들 덕분에 대부분 운영체제나 프로그램 언어에서 사용할 수 있다.

## TCP의 특징과 HTTP에서의 성능 문제

HTTP는 TCP 바로 위에 있는 계층이기 떄문에 HTTP 트랜잭션의 성능은 그 아래 계층인 TCP 성능에 영향을 받게 된다.  
HTTP 요청을 처리할 때 아래와 같은 과정을 거치게 되는데 4번의 트랜잭션 처리는 실제로 상당히 짧은 시간이 걸리는 작업이다.(보통의 경우)  
대부분 HTTP 지연의 대부분은 TCP 커넥션을 설정하고, HTTP 요청을 보내고, HTTP 응답을 받고, TCP 커넥션을 닫는 과정에서 발생한다.

1. DNS 룩업
2. 연결
3. HTTP 요청
4. 트랜잭션 처리
5. HTTP 응답
6. 연결 종료

HTTP에서 TCP 관련 지연은 아래와 같은 이유로 발생한다.

- TCP 커넥션의 핸드셰이크 설정
- TCP의 편승(piggyback) 확인응답(acknowledgement)을 위한 확인 응답 지연 알고리즘
- 인터넷 혼잡을 제어하기 위한 TCP의 느린 시작(slown start)
- 데이터를 한데 모아 보내기 위한 TCP의 Nagle 알고리즘
- TIME_WAIT 지연과 포트 고갈

### 핸드셰이크(Handshake)

어떤 데이터를 전송하든 새로운 TCP 커넥션을 열 때, TCP 소프트웨어는 커넥션을 맺기 위한 조건을 위해 연속으로 패킷을 교환해야하며 순서는 아래와 같다.

1. 클라이언트가 TCP 커넥션을 생성하기 위해 작은 TCP 패킷을 서버에 전송(`SYN` 플래그를 지닌 패킷)
2. 서버가 클라이언트에게 커넥션을 받으면 몇 가지 커넥션 매개변수를 산출하고, `SYN`과 `ACK` 플래그를 지닌 패킷을 클라이언트에게 전송
3. 클라이언트는 커넥션이 잘 맺어졌으면 서버에게 다시 `ACK` 플래그를 지닌 확인응답 패킷과 함께 데이터를 전송

위 과정에서 1번 + 2번 과정의 지연이 많이 발생하게 된다.

### 확인응답 지연

인터넷 자체는 신뢰할 수 없는 네트워크이기 때문에 TCP에서 성공적인 데이터 전송을 보장하기 위해 아래와 같은 과정을 거치게 된다.

- TCP의 각 세그먼트에 순번과 데이터 무결성 체크섬을 포함 시켜 전송
- 각 세그먼트의 수신자는 세그먼트 수신
    - 올바르게 받았을 때 작은 확인응답 패킷을 송신자에게 반환
    - 송신자 측에서 확인 응답 메시지를 받지 못하면 세그먼트를 다시 전송

여기서 확인응답은 크기가 작기 때문에, TCP는 같은 방향을 송출되는 데이터 패킷에 확인응답을 편승(piggyback) 시켜서 송출 데이터 패킷과 함께 전송하여 네트워크를 좀 더 효율적으로 사용할 수 있게 한다.  
확인응답이 같은 방향으로 가는 데이터 패킷에 편승되는 경우를 늘리기 위해, 많은 TCP 스택에서 아래와 같은 확인응답을 지연 알고리즘을 구현하여 네트워크 효율을 높이고 있다.

- 송출할 확인응답을 특정 시간 동안 버퍼에 저장
- 버퍼에 저장된 확인응답을 송출할 데이터 패킷을 탐색
- 확인응답을 송출할 데이터 패킷이 있으면 확인응답을 편승시켜서 전송
- 확인응답을 송출할 데이터 패킷이 없으면 확인응답 패킷을 별도로 전송

요청과 응답 두 가지 형식으로만 이루어지는 HTTP 동작 방식에서는 송출 데이터 패킷에 편승할 기회가 많이 없기 때문에 해당 알고리즘으로 인한 지연이 많이 발생할 수 있게된다.

### 느린 시작(slown start)

TCP 커넥션은 시간이 지나면서 자체적으로 튜닝되어서, 처음에는 커넥션의 최대 속도를 제한하고 성공적으로 전송됨에 따라 속도를 늘려가는 방식으로 동작한다.  
때문에 TCP 커넥션이 생성된 시간에 따라 전송 속도가 달라지게 되며, 이는 인터넷 급작스러운 부하와 혼잡을 방지하는 데 있는 것이다.  
TCP의 느린 시작은 한 번에 전송할 수 있는 패킷의 수를 제한하고 전송 성공률이 높아지면 패킷의 수를 늘려가는 방식으로 동작한다.

### Nagle 알고리즘

TCP는 애플리케이션이 어떤 크기의 데이터든지 TCP 스택으로 전송할 수 있도록 데이터 스트림 인터페이스를 제공하지만, 각 TCP 세그먼트는 40바이트 상당의 플래그와 헤더를 가지고 있다.  
떄문에 TCP가 작은 크기의 데이터를 많은 수의 패킷을 전송하면 네트워크 성능은 크게 떨어지게 된다.  
이를 해결하기 위해 Nagle 알고리즘은 TCP가 작은 크기의 데이터를 전송할 때, 데이터가 모이기를 기다리다가 일정 크기가 되면 한 번에 전송하는 방식으로 동작한다.  
하지만 Nagle 알고리즘은 네트워크 성능을 향상시키는 데 도움이 되지만, HTTP에서는 데이터가 모이기를 기다리는 시간이 너무 길어지기 때문에 성능이 저하되는 문제가 발생한다.

### TIME_WAIT의 누적과 포트 고갈

TCP 커넥션을 끊으면, 종단에서는 커넥션의 IP 주소와 포트 번호를 메모리의 제어 영역에 기록해놓는데, 이 정보는 같은 주소와 포트 번호를 사용하는 새로운 TCP 커넥션이 일정 시간 동안에는 생성되지 않도록
방지하는 역할을 한다.  
일반적으로 커넥션 종료 지연이 문제가 되지는 않지만 TCP 커넥션을 많이 생성하고 종료하는 서버(성능 시험 등)에서는 TIME_WAIT 상태의 커넥션을 누적시켜서 포트 고갈 문제가 발생하여 서버가 응답하지 않는
현상이 발생할 수 있다.

## UDP - 사용자 데이터그램 프로토콜(User Datagram Protocol)

- 기능이 거의 없음
- 연결지향/데이터 전달 보증/순서 보장이 없음
- 단순하지만 빠른 속도
- IP와 거의 같으나 PORT, 체크섬 정도의 기능만 지님
- 기능이 필요할 경우 UDP 위에 기능을 추가하여 사용
    - TCP를 주로 사용했지만 최근에는 UDP에 기능을 추가 및 최적화하여 사용

###### 출처

- [HTTP 완벽 가이드](https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=294437345)