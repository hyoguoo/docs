---
layout: editorial
---

# 네트워크 계층 (Network Layer) - TCP/IP Layer 2

> 물리 계층과 데이터 계층에 해당하는 Network Access Layer는 LAN에 국한된 통신을 담당하는 계층이다.  
> 네트워크 계층은 LAN을 넘어서기 위한 계층으로, 라우팅을 하여 네트워크 간 통신이 가능하도록 한다.

현재 사용되는 대표적인 프로토콜로 IP(Internet Protocol)가 있다.

## MAC 주소가 있지만 IP 주소도 필요한 이유

모든 네트워크 장비는 MAC 주소를 가지고 있기 때문에 임의의 네트워크에 속한 MAC 주소를 파악하여 통신하는 것은 불가능에 가깝다.  
때문에 IP 주소를 통해 네트워크를 식별하고, 식별한 네트워크에 속한 장비들의 MAC 주소를 파악하여 통신을 한다.

|         MAC 주소          |           IP 주소            |
|:-----------------------:|:--------------------------:|
| 네트워크 장비에 할당된 고유한 물리적 주소 | 네트워크에 연결된 컴퓨터를 식별하는 논리적 주소 |
| 네트워크 장비가 제조사에 의해 직접 할당  |        네트워크 관리자가 할당        |
|      일반적으로 변경 불가능       |           변경 가능            |
|      48비트(6바이트) 길이      |    일반적으로 32비트(4바이트) 길이     |

## IP의 주요 기능

### IP 주소 지정

IP 주소는 직접 지정할 수도 있지만, DHCP(Dynamic Host Configuration Protocol)를 통해 자동으로 할당받을 수도 있다.

### 단편화(Fragmentation)

패킷의 크기를 MTU(Maximum Transmission Unit)라고 하며, 일반적으로 1500byte(=약 1.4kb)이다.  
더 큰 데이터를 전송하기 위해서는 L3 패킷을 분할하여 전송하는 단편화(Fragmentation)를 수행하고, 목적지에서 다시 재조립하여 사용한다.

## IP 주소 종류

IPv4와 IPv6가 존재하며, IPv4는 32비트로 구성되어 있고, IPv6는 128비트로 구성되어 있다.  
현재는 둘 다 사용하지만 아직까지 IPv4가 주로 사용되고 있으며, IPv6는 IPv4의 주소 고갈 문제를 방지하기 위해 등장하였다.(실제론 다른 기술로 IPv4 주소 고갈 문제를 해결하고 있다.)

|       IPv4        |                  IPv6                   |
|:-----------------:|:---------------------------------------:|
|    4바이트(32비트)     |              16바이트(128비트)               |
| 0 ~ 255까지의 숫자로 표현 |                16진수로 표현                 |
| 8비트씩 4개의 옥텟으로 구성  |            16비트씩 8개의 옥텟으로 구성            |
|    192.168.1.1    | 2001:0db8:85a3:0000:0000:8a2e:0370:7334 |

### IPv4의 헤더

- 단편화에 사용되는 헤더 정보
    - 식별자: 단편화된 패킷을 재조립할 때 사용하는 식별값
    - 플래그: 단편화에 대한 정보를 담고 있는 비트열
    - 단편화 오프셋: 단편화되기 전 원본 데이터에서 해당 패킷이 위치한 오프셋
- 그 외
    - TTL(Time To Live): 패킷이 네트워크 장치(라우터)를 통과할 때마다 1씩 감소하는 카운터로, 0이 되면 해당 패킷은 폐기, 폐기 시 장치에서 ICMP 메시지 전송
    - 프로토콜: 상위 계층 프로토콜을 명시하는 필드(TCP: 6, UDP: 17... etc)
    - 헤더 체크섬
- 주소 정보
    - 송신지 IP 주소
    - 목적지 IP 주소

### IPv6의 헤더

- 페이로드 길이
- 다음 헤더(=확장 헤더): 고정되지 않은 헤더로, 필요한 경우 추가되는 헤더(ex. 단편화, 인증, 암호화 등)
- 홉 제한: TTL과 비슷한 역할
- 주소 정보
    - 송신지 IP 주소
    - 목적지 IP 주소

## ARP(Address Resolution Protocol)

> IP 주소를 MAC 주소로 변환하는 프로토콜

IP 프로토콜로 통신을 하기 위해서는 MAC 주소가 필요하지만 실제로는 IP 주소를 알지만 MAC 주소를 모르는 경우가 많다.  
이 때 ARP를 통해 IP 주소를 MAC 주소로 변환하여 통신을 한다.  
ARP는 `동일 네트워크 내`의 호스트의 MAC 주소를 알아내기 위한 프로토콜이며, IP 주소를 통해 MAC 주소를 알아내는 과정은 아래와 같다.

1. ARP 요청(브로드 캐스트 메시지)
    - ARP 요청 메시지를 브로드 캐스트하여 해당 IP 주소를 가진 호스트가 있는지 확인
2. ARP 응답
    - 해당 IP 주소를 가진 호스트가 있다면, 해당 호스트가 자신의 MAC 주소를 담은 ARP 응답 메시지를 전송
3. ARP 캐시 테이블 갱신
    - MAC 주소와 IP 주소가 매핑된 형태의 ARP 캐시 테이블을 갱신
    - ARP에 저장된 주소에 대해서는 다시 ARP 요청을 보내지 않고, ARP 캐시 테이블을 통해 바로 통신
    - ARP 캐시 테이블은 일정 시간이 지나면 삭제되며, 삭제된 경우 ARP 요청을 통해 다시 매핑

하지만 ARP는 `동일 네트워크 내`의 호스트의 MAC 주소를 알아내기 위한 프로토콜이기 때문에, 다른 네트워크에 있는 호스트의 MAC 주소를 알아내기 위해서는 다른 프로토콜도 사용하여 통신하게 된다.

## ICMP(Internet Control Message Protocol)

IP 프로토콜에는 비신뢰성, 비연결형 전달을 한다는 점에서 한계가 있다.

- 비신뢰성: 패킷이 목적지까지 제대로 전송하지 않을 수 있음
- 비연결형: 호스트 간 연결을 설정하지 않고 통신을 하기 때문에, 패킷을 보내는 호스트가 패킷을 보내는 동안 목적지 호스트가 살아있는지 확인하지 않음

TCP/IP 3계층의 TCP를 이용하여 위 두 가지 한계를 해결할 수 있지만, 네트워크 계층 내의 ICMP 프로토콜을 이용하여 위 두 가지 한계를 보완할 수 있다.(완전한 해결은 아님)

ICMP는 IP 프로토콜의 비신뢰성과 비연결형의 한계를 보완하기 위한 네트워크 계층 프로토콜로, IP 패킷의 전송 과정에 대한 정보를 제공한다.  
네트워크 연결을 확인하는 `ping` 명령어가 내부적으로 ICMP를 사용하여 동작한다.

## 127.0.0.1(Localhost)

로컬호스트 IP로 루프백(Loopback) 네트워크 인터페이스로 사용하기 위해 예약해 놓은 IP로, 자신의 컴퓨터를 의미한다.  
해당 IP에 요청하기 되면 외부 네트워크로부터 격리되며 물리적인 네트워크 인터페이스를 통하지 않고, 컴퓨터 내부에서만 통신이 이루어진다.

![Loopback Network](image/loopback_network_ipc.png)

###### 참고자료

- [외워서 끝내는 네트워크 핵심이론 - 기초](https://www.inflearn.com/course/네트워크-핵심이론-기초)
- [현실 세상의 컴퓨터 공학 지식 - 네트워크](https://fastcampus.co.kr/dev_online_newcomputer)